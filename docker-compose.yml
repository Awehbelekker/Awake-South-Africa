# ============================================
# AWAKE BOARDS SA - Docker Compose
# Complete Self-Hosted E-Commerce Infrastructure
# ============================================

version: "3.8"

services:
  # ============================================
  # DATABASE LAYER
  # ============================================
  
  postgres:
    image: postgres:15-alpine
    container_name: awake-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_MULTIPLE_DATABASES: medusa,calcom,twenty,chatwoot,n8n,metabase,authentik
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
    ports:
      - "5432:5432"
    networks:
      - awake-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: awake-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - awake-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # E-COMMERCE - MEDUSA
  # ============================================
  
  medusa:
    build:
      context: ./services/medusa
      dockerfile: Dockerfile
    container_name: awake-medusa
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${ENVIRONMENT:-development}
      DATABASE_URL: ${MEDUSA_DATABASE_URL}
      REDIS_URL: ${MEDUSA_REDIS_URL}
      JWT_SECRET: ${MEDUSA_JWT_SECRET}
      COOKIE_SECRET: ${MEDUSA_COOKIE_SECRET}
      STORE_CORS: ${MEDUSA_STORE_CORS}
      ADMIN_CORS: ${MEDUSA_ADMIN_CORS}
    volumes:
      - medusa_data:/app/uploads
    ports:
      - "9000:9000"
    networks:
      - awake-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # STOREFRONT - NEXT.JS
  # ============================================
  
  storefront:
    build:
      context: ./services/storefront
      dockerfile: Dockerfile
    container_name: awake-storefront
    restart: unless-stopped
    depends_on:
      - medusa
    environment:
      NODE_ENV: ${ENVIRONMENT:-development}
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${NEXT_PUBLIC_MEDUSA_BACKEND_URL}
      NEXT_PUBLIC_STORE_URL: ${NEXT_PUBLIC_STORE_URL}
      NEXT_PUBLIC_CALCOM_EMBED_URL: ${NEXT_PUBLIC_CALCOM_EMBED_URL}
      PAYFAST_MERCHANT_ID: ${PAYFAST_MERCHANT_ID}
      PAYFAST_MERCHANT_KEY: ${PAYFAST_MERCHANT_KEY}
      PAYFAST_PASSPHRASE: ${PAYFAST_PASSPHRASE}
      PAYFAST_SANDBOX: ${PAYFAST_SANDBOX:-true}
    ports:
      - "3000:3000"
    networks:
      - awake-network

  # ============================================
  # BOOKING - CAL.COM
  # ============================================
  
  calcom:
    image: calcom/cal.com:latest
    container_name: awake-calcom
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: ${CALCOM_DATABASE_URL}
      NEXTAUTH_SECRET: ${CALCOM_NEXTAUTH_SECRET}
      CALENDSO_ENCRYPTION_KEY: ${CALCOM_CALENDSO_ENCRYPTION_KEY}
      NEXT_PUBLIC_WEBAPP_URL: http://localhost:3001
      NEXT_PUBLIC_LICENSE_CONSENT: agree
    ports:
      - "3001:3000"
    networks:
      - awake-network

  # ============================================
  # CRM - TWENTY
  # ============================================
  
  twenty:
    image: twentycrm/twenty:latest
    container_name: awake-twenty
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_DATABASE_URL: ${TWENTY_DATABASE_URL}
      SERVER_URL: ${TWENTY_SERVER_URL}
      FRONT_AUTH_URL: ${TWENTY_FRONT_AUTH_URL}
    ports:
      - "3002:3000"
    networks:
      - awake-network

  # ============================================
  # CUSTOMER SUPPORT - CHATWOOT
  # ============================================
  
  chatwoot:
    image: chatwoot/chatwoot:latest
    container_name: awake-chatwoot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: ${CHATWOOT_DATABASE_URL}
      REDIS_URL: ${CHATWOOT_REDIS_URL}
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      FRONTEND_URL: http://localhost:3003
      MAILER_SENDER_EMAIL: ${CHATWOOT_MAILER_SENDER_EMAIL}
      SMTP_ADDRESS: ${CHATWOOT_SMTP_ADDRESS}
      SMTP_PORT: ${CHATWOOT_SMTP_PORT}
      SMTP_USERNAME: ${CHATWOOT_SMTP_USERNAME}
      SMTP_PASSWORD: ${CHATWOOT_SMTP_PASSWORD}
    ports:
      - "3003:3000"
    networks:
      - awake-network
    command: bundle exec rails s -p 3000 -b 0.0.0.0

  chatwoot-worker:
    image: chatwoot/chatwoot:latest
    container_name: awake-chatwoot-worker
    restart: unless-stopped
    depends_on:
      - chatwoot
    environment:
      DATABASE_URL: ${CHATWOOT_DATABASE_URL}
      REDIS_URL: ${CHATWOOT_REDIS_URL}
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
    networks:
      - awake-network
    command: bundle exec sidekiq -C config/sidekiq.yml

  # ============================================
  # AUTOMATION - N8N
  # ============================================
  
  n8n:
    image: n8nio/n8n:latest
    container_name: awake-n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      DB_TYPE: ${N8N_DATABASE_TYPE}
      DB_POSTGRESDB_HOST: ${N8N_DATABASE_HOST}
      DB_POSTGRESDB_PORT: ${N8N_DATABASE_PORT}
      DB_POSTGRESDB_DATABASE: ${N8N_DATABASE_NAME}
      DB_POSTGRESDB_USER: ${N8N_DATABASE_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_DATABASE_PASSWORD}
      GENERIC_TIMEZONE: Africa/Johannesburg
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/workflows:/home/node/workflows:ro
    ports:
      - "5678:5678"
    networks:
      - awake-network

  # ============================================
  # ANALYTICS - METABASE
  # ============================================
  
  metabase:
    image: metabase/metabase:latest
    container_name: awake-metabase
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: metabase
      MB_DB_PASS: ${METABASE_DB_PASSWORD}
      MB_DB_HOST: postgres
    ports:
      - "3004:3000"
    networks:
      - awake-network

  # ============================================
  # AUTHENTICATION - AUTHENTIK
  # ============================================
  
  authentik-server:
    image: ghcr.io/goauthentik/server:latest
    container_name: awake-authentik-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_DB_PASSWORD}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PASSWORD: ${REDIS_PASSWORD}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${AUTHENTIK_BOOTSTRAP_PASSWORD}
      AUTHENTIK_BOOTSTRAP_EMAIL: ${AUTHENTIK_BOOTSTRAP_EMAIL}
    command: server
    ports:
      - "9443:9443"
      - "9080:9000"
    networks:
      - awake-network

  authentik-worker:
    image: ghcr.io/goauthentik/server:latest
    container_name: awake-authentik-worker
    restart: unless-stopped
    depends_on:
      - authentik-server
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_DB_PASSWORD}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PASSWORD: ${REDIS_PASSWORD}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
    command: worker
    networks:
      - awake-network

  # ============================================
  # MONITORING - UPTIME KUMA
  # ============================================
  
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: awake-uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma_data:/app/data
    ports:
      - "3005:3001"
    networks:
      - awake-network

# ============================================
# VOLUMES
# ============================================

volumes:
  postgres_data:
  redis_data:
  medusa_data:
  n8n_data:
  uptime_kuma_data:

# ============================================
# NETWORKS
# ============================================

networks:
  awake-network:
    driver: bridge
