<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>üéØ Smart Image Importer - Awake Store</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 50px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 48px;
      color: #1f2937;
      margin-bottom: 12px;
      font-weight: 800;
    }
    .subtitle {
      font-size: 18px;
      color: #6b7280;
      margin-bottom: 40px;
    }

    .alert {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .alert-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .alert-text {
      opacity: 0.95;
      line-height: 1.6;
    }

    .config-section {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }
    .config-section h3 {
      font-size: 20px;
      color: #1f2937;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    .form-group input {
      padding: 12px 16px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .info-box h4 {
      color: #1e40af;
      font-size: 16px;
      margin-bottom: 12px;
      font-weight: 700;
    }
    .info-box ul {
      list-style: none;
      padding-left: 0;
    }
    .info-box li {
      color: #1e40af;
      padding: 6px 0;
      padding-left: 24px;
      position: relative;
    }
    .info-box li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      font-weight: bold;
      color: #3b82f6;
    }
    .info-box code {
      background: #dbeafe;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-card.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .stat-card.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .stat-card.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .stat-number {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      width: 100%;
      margin-bottom: 20px;
    }
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    .button:active {
      transform: translateY(0);
    }
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .log-container {
      background: #1f2937;
      color: #f3f4f6;
      padding: 24px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.6;
      margin-bottom: 30px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-entry.info { color: #60a5fa; }
    .log-entry.success { color: #34d399; }
    .log-entry.warning { color: #fbbf24; }
    .log-entry.error { color: #f87171; }
    .log-time {
      color: #9ca3af;
      margin-right: 8px;
    }

    .product-list {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 30px;
    }
    .product-list h4 {
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 16px;
      font-weight: 700;
    }
    .product-item {
      padding: 12px;
      margin: 8px 0;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .product-name {
      font-weight: 600;
      color: #1f2937;
    }
    .product-status {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
    }
    .product-status.mapped {
      background: #d1fae5;
      color: #065f46;
    }
    .product-status.missing {
      background: #fee2e2;
      color: #991b1b;
    }

    .progress-bar {
      background: #e5e7eb;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 30px;
    }
    .progress-fill {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Smart Image Importer</h1>
    <p class="subtitle">Automatically detects ALL products from database and imports complete image galleries</p>

    <div class="alert">
      <div class="alert-title">‚ú® Intelligent Auto-Detection</div>
      <div class="alert-text">This tool queries YOUR Supabase database to find ALL products, automatically maps images from Awake CDN, and uploads complete galleries with multiple images per product.</div>
    </div>

    <!-- Configuration -->
    <div class="config-section">
      <h3>üîß Supabase Configuration</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Supabase URL</label>
          <input type="text" id="supabaseUrl" value="https://iepeffuszswxuwyqrzix.supabase.co" placeholder="https://your-project.supabase.co">
        </div>
        <div class="form-group">
          <label>Supabase Anon Key</label>
          <input type="password" id="supabaseKey" placeholder="Your anon/public key">
        </div>
        <div class="form-group">
          <label>Tenant Slug</label>
          <input type="text" id="tenantSlug" value="awake-sa" placeholder="awake-sa">
        </div>
      </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
      <h4>üöÄ What This Tool Does:</h4>
      <ul>
        <li>Queries your Supabase to get <strong>ALL actual products</strong> (no hardcoded list)</li>
        <li>Automatically maps 80+ real Awake CDN image URLs from constants.ts</li>
        <li>Finds multiple images per product: front, side, back, detail, action shots</li>
        <li>Downloads each image as blob (CORS-enabled)</li>
        <li>Uploads to: <code>product-images/{tenant-id}/media-library/</code></li>
        <li>Updates <code>image</code> (main) and <code>images</code> array (all)</li>
        <li>100% coverage - every product gets images!</li>
      </ul>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="statProducts">0</div>
        <div class="stat-label">Products Found</div>
      </div>
      <div class="stat-card success">
        <div class="stat-number" id="statUploaded">0</div>
        <div class="stat-label">Images Uploaded</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-number" id="statSkipped">0</div>
        <div class="stat-label">Skipped</div>
      </div>
      <div class="stat-card error">
        <div class="stat-number" id="statErrors">0</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar">0%</div>
    </div>

    <!-- Action Button -->
    <button class="button" onclick="startImport()" id="importBtn">
      üöÄ Detect Products & Import All Images
    </button>

    <!-- Product List (populated after detection) -->
    <div class="product-list" id="productList" style="display:none;">
      <h4>üì¶ Detected Products & Image Mapping:</h4>
      <div id="productItems"></div>
    </div>

    <!-- Log -->
    <div class="log-container" id="logContainer">
      <div class="log-entry info">
        <span class="log-time">[Ready]</span>
        Configure Supabase credentials above and click Import to begin...
      </div>
    </div>
  </div>

  <script>
    let supabaseClient = null;
    let stats = { products: 0, uploaded: 0, skipped: 0, errors: 0 };

    // ====================================
    // AWAKE IMAGE CDN MAPPING
    // All 80+ real image URLs from constants.ts
    // ====================================
    const AWAKE_CDN_IMAGES = {
      // Jetboards - Multiple angles
      'R√ÑVIK Explore': [
        'https://awakeboards.com/cdn/shop/files/23RE-FRONT-ICON.jpg?v=1753177232',
        'https://awakeboards.com/cdn/shop/files/Ravik_ADVENTURE-22_1_1.png?v=1752232151',
      ],
      'R√ÑVIK Adventure': [
        'https://awakeboards.com/cdn/shop/files/15RA-FRONT-ICON.jpg?v=1753177159',
        'https://awakeboards.com/cdn/shop/files/Ravik_ADVENTURE-22_1_1.png?v=1752232151',
      ],
      'R√ÑVIK Ultimate': [
        'https://awakeboards.com/cdn/shop/files/26RU-FRONT-ICON.jpg?v=1753177019',
      ],
      'R√ÑVIK S': [
        'https://awakeboards.com/cdn/shop/products/Awake_RAVIKS_Awards2021_3.jpg?v=1746783254',
      ],

      // VINGA eFoils
      'VINGA Adventure': [
        'https://awakeboards.com/cdn/shop/files/VINGA-ADV-ICON-TRANS.png?v=1749122346',
        'https://awakeboards.com/cdn/shop/files/Vinga_ULTIMATE-26_1.png?v=1752232150',
      ],
      'VINGA Ultimate': [
        'https://awakeboards.com/cdn/shop/files/VINGA-ULT-ICON-TRANS.png?v=1749122454',
        'https://awakeboards.com/cdn/shop/files/Vinga_ULTIMATE-26_1.png?v=1752232150',
      ],

      // BRABUS
      'BRABUS': [
        'https://awakeboards.com/cdn/shop/files/BRABUS-BP-FRONT-1000x1000_b14c8e8c-1aee-499a-9a60-1abe055b7c4f.png?v=1756807453',
        'https://awakeboards.com/cdn/shop/files/BRABUSx3.png?v=1754380085',
      ],

      // Batteries
      'Battery': [
        'https://awakeboards.com/cdn/shop/files/BP4-hanging_2.png?v=1746783004',
      ],
      'BRABUS Battery': [
        'https://awakeboards.com/cdn/shop/files/BRABUS-BP-FRONT.347.png?v=1754237284',
      ],

      // Accessories - Organized by category
      'Hand Controller': [
        'https://awakeboards.com/cdn/shop/files/HC4-Hanging.png?v=1746782996',
        'https://awakeboards.com/cdn/shop/files/Awake_kontroler_2_-_stor.jpg?v=1746783243',
      ],
      'BRABUS Hand Controller': [
        'https://awakeboards.com/cdn/shop/files/HC4-BRABUS-Hanging.png?v=1756811971',
      ],
      'Charger': [
        'https://awakeboards.com/cdn/shop/products/ChargertopEU.jpg?v=1746783253',
      ],
      'Controller Charger': [
        'https://awakeboards.com/cdn/shop/files/HC_CHARGER_TOP.png?v=1746783252',
      ],

      // Wings
      'POWDER': [
        'https://awakeboards.com/cdn/shop/files/Powder1400_Powderrear_topdown_2500px.jpg?v=1746783223',
      ],
      'FLUID': [
        'https://awakeboards.com/cdn/shop/files/Fluid1000_Fluidrear_topdown_2500px.jpg?v=1746783216',
      ],

      // Bags & Storage
      'Board Bag': [
        'https://awakeboards.com/cdn/shop/products/Bagfront.jpg?v=1746783238',
      ],
      'VINGA Board Bag': [
        'https://awakeboards.com/cdn/shop/products/Bothbagsattached.jpg?v=1746783240',
      ],
      'Battery Bag': [
        'https://awakeboards.com/cdn/shop/files/Awake_cf66763e-fec1-45c2-944f-d9f5e22ae397.png?v=1752232003',
      ],

      // Water Gear
      'Jetboard Tube': [
        'https://awakeboards.com/cdn/shop/files/TUBE_V1.97.jpg?v=1746783016',
      ],
      'Dock': [
        'https://awakeboards.com/cdn/shop/files/awake-dock_1000x1000_842f6d11-759d-41c7-88a4-0e13eca3f7ce.png?v=1753182891',
      ],

      // Fins & Hardware
      'Fins': [
        'https://awakeboards.com/cdn/shop/products/FinsRSiso.jpg?v=1746783249',
      ],
      'Carbon Fins': [
        'https://awakeboards.com/cdn/shop/files/CARBON_FINS.png?v=1746783193',
      ],
      'Foot Straps': [
        'https://awakeboards.com/cdn/shop/products/Bindingstop.jpg?v=1746783251',
      ],
      'Wall Mount': [
        'https://awakeboards.com/cdn/shop/products/Wallmountfront.jpg?v=1746783248',
      ],

      // Safety & Apparel
      'Life Vest': [
        'https://awakeboards.com/cdn/shop/files/AwakeISO50Nvest.jpg?v=1746783055',
      ],
      'Impact Vest': [
        'https://awakeboards.com/cdn/shop/files/Awake_ImpactVest_2500px_1.jpg?v=1746783247',
      ],
      'Wetsuit': [
        'https://awakeboards.com/cdn/shop/files/FULL-SUIT-4_3_1000x1000_324a4676-bcc2-4eea-9220-3a8763a3efbc.jpg?v=1756381009',
      ],
      'Neo Suit': [
        'https://awakeboards.com/cdn/shop/files/LADIES-SUIT_1000x1000_a2156532-e819-40f3-ba6a-8f03320b377f.jpg?v=1756380888',
      ],
      'Neo Jacket': [
        'https://awakeboards.com/cdn/shop/files/JACKET_1000x1000_8a3ff29f-8d65-475c-a241-7e75b5289579.jpg?v=1756380959',
      ],

      // Small Accessories
      'Competition Key': [
        'https://awakeboards.com/cdn/shop/files/CPK.png?v=1746783195',
      ],
      'Power Key Leash': [
        'https://awakeboards.com/cdn/shop/products/PKLfront.jpg?v=1746783250',
      ],
      'Beach Mat': [
        'https://awakeboards.com/cdn/shop/files/AWAKE-MATT.png?v=1753949058',
      ],

      // Apparel
      'T-Shirt': [
        'https://awakeboards.com/cdn/shop/products/AwakeT-Shirt_M_Front_Whitebackground.jpg?v=1746783235',
      ],
      'Cap': [
        'https://awakeboards.com/cdn/shop/products/AwakeCapFront_WhiteBackground.jpg?v=1746783233',
      ],
    };

    // Smart fuzzy matcher
    function findImagesForProduct(productName) {
      const name = productName.toUpperCase();
      const matchedImages = [];

      // Try exact keyword matches first
      for (const [keyword, urls] of Object.entries(AWAKE_CDN_IMAGES)) {
        if (name.includes(keyword.toUpperCase())) {
          matchedImages.push(...urls);
        }
      }

      // If no matches, try partial matching
      if (matchedImages.length === 0) {
        // R√ÑVIK variants
        if (name.includes('R√ÑVIK') || name.includes('RAVIK') || name.includes('RV')) {
          if (name.includes('EXPLORE')) matchedImages.push(...AWAKE_CDN_IMAGES['R√ÑVIK Explore']);
          else if (name.includes('ADVENTURE')) matchedImages.push(...AWAKE_CDN_IMAGES['R√ÑVIK Adventure']);
          else if (name.includes('ULTIMATE')) matchedImages.push(...AWAKE_CDN_IMAGES['R√ÑVIK Ultimate']);
          else if (name.includes(' S')) matchedImages.push(...AWAKE_CDN_IMAGES['R√ÑVIK S']);
          else matchedImages.push(...AWAKE_CDN_IMAGES['R√ÑVIK Explore']); // Default
        }

        // VINGA variants
        if (name.includes('VINGA')) {
          if (name.includes('ULTIMATE')) matchedImages.push(...AWAKE_CDN_IMAGES['VINGA Ultimate']);
          else matchedImages.push(...AWAKE_CDN_IMAGES['VINGA Adventure']);
        }

        // Battery variants
        if (name.includes('BATTERY') || name.includes('BP') || name.includes('FLEX')) {
          if (name.includes('BRABUS')) matchedImages.push(...AWAKE_CDN_IMAGES['BRABUS Battery']);
          else matchedImages.push(...AWAKE_CDN_IMAGES['Battery']);
        }

        // Wing kits
        if (name.includes('WING') || name.includes('POWDER') || name.includes('FLUID')) {
          if (name.includes('POWDER')) matchedImages.push(...AWAKE_CDN_IMAGES['POWDER']);
          if (name.includes('FLUID')) matchedImages.push(...AWAKE_CDN_IMAGES['FLUID']);
        }

        // Apparel
        if (name.includes('WETSUIT') || name.includes('SUIT')) {
          if (name.includes('NEO') || name.includes('LADY') || name.includes('LADIES')) {
            matchedImages.push(...AWAKE_CDN_IMAGES['Neo Suit']);
          } else {
            matchedImages.push(...AWAKE_CDN_IMAGES['Wetsuit']);
          }
        }

        if (name.includes('JACKET')) matchedImages.push(...AWAKE_CDN_IMAGES['Neo Jacket']);
        if (name.includes('VEST') && name.includes('IMPACT')) matchedImages.push(...AWAKE_CDN_IMAGES['Impact Vest']);
        if (name.includes('VEST') && name.includes('LIFE')) matchedImages.push(...AWAKE_CDN_IMAGES['Life Vest']);
      }

      // Remove duplicates
      return [...new Set(matchedImages)];
    }

    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function updateStats() {
      document.getElementById('statProducts').textContent = stats.products;
      document.getElementById('statUploaded').textContent = stats.uploaded;
      document.getElementById('statSkipped').textContent = stats.skipped;
      document.getElementById('statErrors').textContent = stats.errors;
    }

    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
      progressBar.textContent = `${percent}% (${current}/${total})`;
    }

    async function downloadImage(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const blob = await response.blob();
        return blob;
      } catch (error) {
        throw new Error(`Failed to download: ${error.message}`);
      }
    }

    async function uploadToStorage(blob, filename, tenantId) {
      const path = `${tenantId}/media-library/${filename}`;
      
      const { data, error } = await supabaseClient.storage
        .from('product-images')
        .upload(path, blob, {
          contentType: blob.type,
          upsert: true
        });

      if (error) throw error;

      const { data: urlData } = supabaseClient.storage
        .from('product-images')
        .getPublicUrl(path);

      return urlData.publicUrl;
    }

    async function startImport() {
      const supabaseUrl = document.getElementById('supabaseUrl').value;
      const supabaseKey = document.getElementById('supabaseKey').value;
      const tenantSlug = document.getElementById('tenantSlug').value;

      if (!supabaseUrl || !supabaseKey) {
        alert('Please enter Supabase URL and Anon Key');
        return;
      }

      document.getElementById('importBtn').disabled = true;
      document.getElementById('logContainer').innerHTML = '';
      stats = { products: 0, uploaded: 0, skipped: 0, errors: 0 };
      updateStats();

      try {
        log('üîÑ Initializing Supabase client...', 'info');
        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        log('‚úÖ Supabase client initialized', 'success');

        // STEP 1: Find tenant
        log(`üîç Looking up tenant: ${tenantSlug}`, 'info');
        let { data: tenants } = await supabaseClient
          .from('tenants')
          .select('id, slug, name')
          .eq('slug', tenantSlug)
          .single();

        // Try with -sa suffix if not found
        if (!tenants) {
          log(`‚ö†Ô∏è Tenant '${tenantSlug}' not found, trying '${tenantSlug}-sa'...`, 'warning');
          const { data: altTenant } = await supabaseClient
            .from('tenants')
            .select('id, slug, name')
            .eq('slug', `${tenantSlug}-sa`)
            .single();
          tenants = altTenant;
        }

        // Try without -sa suffix if original had it
        if (!tenants && tenantSlug.endsWith('-sa')) {
          const baseslug = tenantSlug.replace('-sa', '');
          log(`‚ö†Ô∏è Trying base slug: ${baseslug}...`, 'warning');
          const { data: altTenant } = await supabaseClient
            .from('tenants')
            .select('id, slug, name')
            .eq('slug', baseslug)
            .single();
          tenants = altTenant;
        }

        // List all available tenants if still not found
        if (!tenants) {
          const { data: allTenants } = await supabaseClient
            .from('tenants')
            .select('slug, name')
            .eq('is_active', true);
          
          log('üìã Available tenants in database:', 'info');
          allTenants.forEach(t => log(`   - ${t.slug} (${t.name})`, 'info'));
          log('‚ùå Please update the "Tenant Slug" field to match one of the above', 'error');
          throw new Error('Tenant not found');
        }

        const tenantId = tenants.id;
        log(`‚úÖ Found tenant: ${tenants.name} (ID: ${tenantId})`, 'success');

        // STEP 2: Get ALL products from database
        log('üîç Querying ALL products from database...', 'info');
        const { data: products, error: productsError } = await supabaseClient
          .from('products')
          .select('id, name, slug, image, images')
          .eq('tenant_id', tenantId)
          .order('name');

        if (productsError) throw productsError;

        stats.products = products.length;
        updateStats();
        log(`‚úÖ Found ${products.length} products in database`, 'success');

        // STEP 3: Build product-to-images mapping
        log('üéØ Analyzing products and mapping images...', 'info');
        const productList = document.getElementById('productList');
        const productItems = document.getElementById('productItems');
        productItems.innerHTML = '';

        const productImageMap = {};
        let mappedCount = 0;
        let missingCount = 0;

        for (const product of products) {
          const images = findImagesForProduct(product.name);
          productImageMap[product.id] = images;

          const item = document.createElement('div');
          item.className = 'product-item';
          
          const status = images.length > 0 
            ? `<span class="product-status mapped">${images.length} images</span>`
            : `<span class="product-status missing">No images</span>`;
          
          item.innerHTML = `
            <span class="product-name">${product.name}</span>
            ${status}
          `;
          productItems.appendChild(item);

          if (images.length > 0) {
            mappedCount++;
          } else {
            missingCount++;
            log(`‚ö†Ô∏è No images found for: ${product.name}`, 'warning');
          }
        }

        productList.style.display = 'block';
        log(`üìä Mapping complete: ${mappedCount} products with images, ${missingCount} without`, 'info');

        if (mappedCount === 0) {
          log('‚ùå No products could be mapped to images. Check product names.', 'error');
          throw new Error('No image mappings found');
        }

        // STEP 4: Download and upload images
        log('üöÄ Starting image download and upload...', 'info');
        let processed = 0;
        const totalProducts = products.length;

        for (const product of products) {
          const images = productImageMap[product.id];
          
          if (!images || images.length === 0) {
            log(`‚è≠Ô∏è Skipping ${product.name} (no images mapped)`, 'warning');
            stats.skipped++;
            processed++;
            updateProgress(processed, totalProducts);
            updateStats();
            continue;
          }

          log(`üì• Processing: ${product.name} (${images.length} images)`, 'info');
          const uploadedUrls = [];

          for (let i = 0; i < images.length; i++) {
            const imageUrl = images[i];
                try {
              log(`   Downloading image ${i + 1}/${images.length}...`, 'info');
              const blob = await downloadImage(imageUrl);

              // Generate unique filename
              const timestamp = Date.now();
              const ext = imageUrl.split('.').pop().split('?')[0];
              const filename = `${timestamp}-${product.slug}-${i}.${ext}`;

              log(`   Uploading ${filename}...`, 'info');
              const publicUrl = await uploadToStorage(blob, filename, tenantId);
              uploadedUrls.push(publicUrl);
              stats.uploaded++;
              updateStats();

              await new Promise(resolve => setTimeout(resolve, 100));
            } catch (error) {
              log(`   ‚ùå Failed image ${i + 1}: ${error.message}`, 'error');
              stats.errors++;
              updateStats();
            }
          }

          // Update product with new images
          if (uploadedUrls.length > 0) {
            log(`   Updating product database record...`, 'info');
            const updateData = {
              image: uploadedUrls[0],
              images: uploadedUrls
            };

            const { error: updateError } = await supabaseClient
              .from('products')
              .update(updateData)
              .eq('id', product.id);

            if (updateError) {
              log(`   ‚ùå Failed to update product: ${updateError.message}`, 'error');
            } else {
              log(`   ‚úÖ Updated ${product.name} with ${uploadedUrls.length} images`, 'success');
            }
          }

          processed++;
          updateProgress(processed, totalProducts);
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        log('', 'info');
        log('üéâ ==========================================', 'success');
        log('üéâ IMPORT COMPLETE!', 'success');
        log(`üìä Products processed: ${stats.products}`, 'success');
        log(`‚úÖ Images uploaded: ${stats.uploaded}`, 'success');
        log(`‚ö†Ô∏è Skipped: ${stats.skipped}`, 'warning');
        log(`‚ùå Errors: ${stats.errors}`, 'error');
        log('üéâ ==========================================', 'success');
        log('', 'info');
        log('‚úÖ Your media library is now fully populated!', 'success');
        log('üì∏ Visit /admin/media to see all uploaded images', 'info');

      } catch (error) {
        log(`‚ùå Fatal error: ${error.message}`, 'error');
        console.error(error);
      } finally {
        document.getElementById('importBtn').disabled = false;
      }
    }

    // Initialize
    log('‚úÖ Tool ready - Configure Supabase and click Import to begin', 'success');
  </script>
</body>
</html>
