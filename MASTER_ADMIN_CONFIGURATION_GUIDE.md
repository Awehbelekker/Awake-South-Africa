# üîê Master Admin Configuration Guide

## Overview
This guide explains how **Master Admin** configures OAuth, AI, and automation settings for each tenant (client) in the multi-tenant platform.

---

## üéØ Architecture: Master Admin vs. Individual OAuth

### ‚ùå What We DON'T Have (Individual OAuth)
- Each tenant admin connects their own Google/Microsoft account
- Each user manages their own OAuth tokens
- No centralized control

### ‚úÖ What We HAVE (Master Admin Controlled)
- **Master Admin** configures OAuth credentials **once per tenant**
- **Master Admin** sets AI API keys and business tone **per tenant**
- **Master Admin** controls automation settings **per tenant**
- Tenants use the configured services without managing credentials

---

## üìä Configuration Levels

### 1. **OAuth Configuration** (Per Tenant)
Master Admin configures Google and Microsoft OAuth for each client:

```json
{
  "google": {
    "enabled": true,
    "clientId": "123456-abc.apps.googleusercontent.com",
    "clientSecret": "GOCSPX-...",
    "scopes": ["drive.file", "calendar"],
    "serviceAccountEmail": "kelp-boards@project.iam.gserviceaccount.com"
  },
  "microsoft": {
    "enabled": true,
    "clientId": "abc123-...",
    "clientSecret": "xyz789~...",
    "tenantId": "microsoft-tenant-id",
    "scopes": ["Files.ReadWrite", "Calendars.ReadWrite"]
  }
}
```

**Use Cases:**
- **Awake SA**: Uses Google Drive for product images
- **Kelp Boards SA**: Uses Microsoft OneDrive for documents
- **Aweh Be Lekker**: Uses both Google Calendar and Microsoft Calendar

### 2. **AI Configuration** (Per Tenant)
Master Admin sets AI provider and business tone for each client:

```json
{
  "provider": "openai",
  "apiKey": "sk-proj-...",
  "model": "gpt-4",
  "visionModel": "gpt-4-vision-preview",
  "maxTokens": 2000,
  "temperature": 0.7,
  "monthlyBudget": 5000,
  "currentSpend": 0,
  "businessTone": {
    "style": "edgy",
    "vibe": "Skateboarding culture, South African slang, youthful energy",
    "targetAudience": "Young adults 18-35, skateboard enthusiasts",
    "keywords": ["aweh", "lekker", "shred", "stoke"]
  }
}
```

**Examples:**
- **Awake SA**: Professional tone, surfing/paddleboarding vibe
- **Kelp Boards SA**: Casual tone, eco-friendly surfing culture
- **Aweh Be Lekker**: Edgy tone, skateboarding slang, youthful energy

### 3. **Automation Configuration** (Per Tenant)
Master Admin controls automation features for each client:

```json
{
  "ocr": {
    "enabled": true,
    "autoCreateSuppliers": true,
    "confidenceThreshold": 0.7
  },
  "payments": {
    "enabled": true,
    "autoProcess": true,
    "maxRetries": 3,
    "requireApprovalAbove": 10000
  },
  "productGeneration": {
    "enabled": true,
    "autoGenerateDescriptions": true,
    "autoFindImages": true,
    "markupPercentage": 35
  }
}
```

**Examples:**
- **Awake SA**: Full automation enabled, 35% markup
- **Kelp Boards SA**: Manual approval for payments > R10,000
- **Aweh Be Lekker**: Auto-generate descriptions with edgy tone

---

## üöÄ How Master Admin Configures Tenants

### Step 1: Access Master Admin Portal
```
URL: https://yourdomain.com/master-admin
Login: master@yoursaas.com
```

### Step 2: Select Tenant
Navigate to **Tenants** ‚Üí Select **Kelp Boards SA**

### Step 3: Configure OAuth
**Google OAuth:**
1. Create OAuth app in Google Cloud Console
2. Copy Client ID and Client Secret
3. Paste into Master Admin ‚Üí Kelp Boards SA ‚Üí OAuth Settings
4. Select scopes: Drive, Calendar
5. Save

**Microsoft OAuth:**
1. Create app registration in Azure Portal
2. Copy Application ID and Client Secret
3. Paste into Master Admin ‚Üí Kelp Boards SA ‚Üí OAuth Settings
4. Select scopes: Files.ReadWrite, Calendars.ReadWrite
5. Save

### Step 4: Configure AI
1. Enter OpenAI API key (or use shared key)
2. Set business tone:
   - **Style**: Casual
   - **Vibe**: "Eco-friendly surfing culture, ocean conservation"
   - **Target Audience**: "Environmentally conscious surfers 25-45"
   - **Keywords**: ["eco", "sustainable", "ocean", "kelp"]
3. Set monthly budget: R5,000
4. Save

### Step 5: Configure Automation
1. Enable OCR invoice scanning
2. Enable auto-create suppliers
3. Enable autonomous payments
4. Set approval threshold: R10,000
5. Enable AI product generation
6. Set markup: 40%
7. Save

---

## üîß API Usage (For Developers)

### Get Tenant Configuration
```typescript
import { getTenantConfig } from '@/lib/master-admin/tenant-config'

const config = await getTenantConfig(tenantId)
console.log(config.ai_config.businessTone)
```

### Update AI Configuration
```typescript
import { updateAIConfig } from '@/lib/master-admin/tenant-config'

await updateAIConfig(tenantId, {
  provider: 'openai',
  apiKey: 'sk-...',
  model: 'gpt-4',
  visionModel: 'gpt-4-vision-preview',
  maxTokens: 2000,
  temperature: 0.7,
  monthlyBudget: 5000,
  currentSpend: 0,
  businessTone: {
    style: 'edgy',
    vibe: 'Skateboarding culture',
    targetAudience: 'Young adults 18-35',
    keywords: ['aweh', 'lekker']
  }
})
```

### Update OAuth Configuration
```typescript
import { updateOAuthConfig } from '@/lib/master-admin/tenant-config'

await updateOAuthConfig(tenantId, {
  google: {
    enabled: true,
    clientId: '...',
    clientSecret: '...',
    scopes: ['drive.file', 'calendar']
  }
})
```

---

## üîê Security

### Credential Storage
- OAuth credentials stored in `master_admin_credentials` table
- Encrypted at rest
- Only accessible via server-side API
- Row-Level Security (RLS) prevents client access

### Master Admin Authentication
- Separate authentication from tenant admins
- Token-based API access
- Activity logging for all configuration changes

### Audit Trail
All Master Admin actions logged in `master_admin_activity_log`:
- Who made the change
- What was changed
- When it was changed
- IP address and user agent

---

## üìã Database Schema

### Tenants Table (Updated)
```sql
ALTER TABLE tenants ADD COLUMN oauth_config JSONB;
ALTER TABLE tenants ADD COLUMN ai_config JSONB;
ALTER TABLE tenants ADD COLUMN automation_config JSONB;
```

### Master Admin Credentials Table
```sql
CREATE TABLE master_admin_credentials (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  credential_type TEXT, -- 'google_oauth', 'microsoft_oauth', 'openai_api'
  encrypted_value TEXT,
  is_active BOOLEAN,
  created_by TEXT -- Master admin email
);
```

### Master Admin Activity Log
```sql
CREATE TABLE master_admin_activity_log (
  id UUID PRIMARY KEY,
  admin_email TEXT,
  action TEXT, -- 'update_oauth_config', 'update_ai_config'
  tenant_id UUID,
  details JSONB,
  created_at TIMESTAMPTZ
);
```

---

## ‚úÖ Summary

**Master Admin Controls:**
- ‚úÖ OAuth credentials (Google + Microsoft) per tenant
- ‚úÖ AI API keys and business tone per tenant
- ‚úÖ Automation settings per tenant
- ‚úÖ Can change AI provider anytime
- ‚úÖ Can update business tone anytime
- ‚úÖ Full audit trail of all changes

**Tenants Get:**
- ‚úÖ Pre-configured OAuth (no setup needed)
- ‚úÖ AI features with custom business tone
- ‚úÖ Automation features ready to use
- ‚úÖ No credential management

**This is a true white-label SaaS platform with centralized Master Admin control!** üöÄ

